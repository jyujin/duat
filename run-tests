#!/bin/sh

rm -f temporary* test-socket*

tests=0;
files=0;

failed=0;
failedfiles=0;
rv=0;

echo ";; running tests"

for i in $(find ./tests -maxdepth 1 ! \( -type d -o \( -name '*.c' -o -name '*.o' \) \) ); do
    let "tests += 1";
    echo $i;

    if $@ $i; then t=1;
    else
        echo " * $i failed (code $?)";
        let "failed += 1";
    fi
done

echo ";; tests completed"
echo ";; checking generated files"

for i in temporary*; do
    let "files += 1";
    echo $i;

    if diff "$i" "tests/reference/$i"; then t=1;
    else
        echo " * file \"$i\" failed verification";
        let "failedfiles += 1";
    fi
done

echo ";; file check completed"

echo ";; ---- test summary ----"
echo ";; tests: ran $tests tests, $failed of them failed";
echo ";; files: checked $files files, $failedfiles of them failed verification";

let "rv = $failedfiles + $failed";

test "$rv" -eq "0"
